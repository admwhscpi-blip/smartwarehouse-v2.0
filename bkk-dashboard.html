<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPI WAREHOUSE - BKK Stock</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/rm_stock_v2.css">
    <link rel="stylesheet" href="homepage-style.css">

    <style>
        body {
            background-color: #050505;
            color: #fff;
            overflow-x: hidden;
        }

        .navbar {
            border-bottom: 1px solid rgba(16, 185, 129, 0.1);
            position: sticky;
            top: 0;
            background: rgba(5, 5, 5, 0.95);
            z-index: 1000;
        }

        .bkk-container {
            padding: 40px 60px;
        }

        .bkk-panel {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(16, 185, 129, 0.1);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(16, 185, 129, 0.1);
            padding-bottom: 15px;
        }

        .panel-title {
            font-family: 'Orbitron';
            font-size: 1.4rem;
            color: #10b981;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.3);
        }

        /* Warehouse Grid - RM Style */
        .warehouse-farm-layout {
            display: flex;
            gap: 30px;
            justify-content: center;
            align-items: flex-start;
            padding: 20px 0;
            min-height: 350px;
        }

        .warehouse-unit {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .warehouse-visual {
            position: relative;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 50%, rgba(16, 185, 129, 0.02) 100%);
            border: 2px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            overflow: hidden;
            box-shadow:
                0 0 20px rgba(0, 0, 0, 0.5),
                inset 0 0 15px rgba(16, 185, 129, 0.05);
            backdrop-filter: blur(2px);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            /* Width and height set dynamically via JS */
            height: 220px;
            /* Grid pattern */
            background-image:
                linear-gradient(rgba(16, 185, 129, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(16, 185, 129, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .warehouse-fill {
            width: 100%;
            background: linear-gradient(180deg, #10b981 0%, #064e3b 100%);
            box-shadow: 0 -2px 10px rgba(16, 185, 129, 0.5);
            position: relative;
            transition: height 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .warehouse-fill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }

        .warehouse-shine {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.03) 20%,
                    rgba(255, 255, 255, 0.1) 40%,
                    rgba(255, 255, 255, 0.03) 60%,
                    rgba(255, 255, 255, 0) 100%);
            pointer-events: none;
            z-index: 10;
        }

        .warehouse-info-card {
            margin-top: 20px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 8px;
            /* Width set dynamically */
            padding: 12px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            position: relative;
            overflow: hidden;
        }

        .warehouse-info-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #10b981, transparent);
        }

        .warehouse-name-label {
            font-family: 'Orbitron';
            color: #fff;
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 5px;
            letter-spacing: 1px;
            border-bottom: 1px solid rgba(16, 185, 129, 0.2);
            padding-bottom: 5px;
        }

        .warehouse-big-percent {
            font-family: 'Orbitron';
            font-size: 1.4rem;
            color: #10b981;
            font-weight: 900;
            margin-bottom: 5px;
            text-shadow: 0 0 15px rgba(16, 185, 129, 0.3);
        }

        .warehouse-data-row {
            font-family: 'Rajdhani';
            font-size: 0.75rem;
            color: #94a3b8;
            display: flex;
            justify-content: space-between;
            margin-bottom: 2px;
        }

        .remark-badge {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid #10b981;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            margin-top: 5px;
            display: inline-block;
            font-weight: 700;
        }

        /* Table Styles */
        .bkk-table {
            width: 100%;
            border-collapse: collapse;
        }

        .bkk-table th {
            text-align: left;
            padding: 15px 20px;
            color: #64748b;
            font-family: 'Orbitron';
            font-size: 0.75rem;
            text-transform: uppercase;
            border-bottom: 1px solid rgba(16, 185, 129, 0.1);
        }

        .bkk-table td {
            padding: 20px;
            font-family: 'Rajdhani';
            font-weight: 600;
            font-size: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: #cbd5e1;
        }

        .percent-bar-bg {
            width: 100px;
            height: 6px;
            background: #1a1a1a;
            border-radius: 3px;
        }

        .percent-bar-fill {
            height: 100%;
            background: #10b981;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="nav-brand">
            <div class="logo-icon">ðŸ“¦</div>
            <div class="logo-text">CPI BKK STOCK</div>
        </div>
        <div class="nav-links">
            <a href="homepage-v1.html" class="nav-link">Home</a>
            <a href="#" class="nav-link active"
                style="color:#10b981; text-shadow:0 0 10px rgba(16,185,129,0.5);">BKK-STOCK</a>
            <a href="bkk-simulasi.html" class="nav-link">BKK-SIMULASI</a>
        </div>
    </nav>

    <div class="bkk-container">
        <!-- WAREHOUSE FARM VISUALS -->
        <div class="bkk-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title">BKK STORAGE LAYOUT</div>
                </div>
            </div>

            <div class="warehouse-farm-layout" id="warehouse-visual-grid">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- WAREHOUSE DATA TABLE -->
        <div class="bkk-panel">
            <div class="panel-header">
                <div>
                    <div class="panel-title" style="font-size:1.2rem; color:#fff;">Physical Inventory Data</div>
                </div>
            </div>
            <table class="bkk-table">
                <thead>
                    <tr>
                        <th>Warehouse</th>
                        <th>Material</th>
                        <th>Supplier</th>
                        <th>Stock (kg)</th>
                        <th>Capacity (kg)</th>
                        <th>Fill %</th>
                        <th>Age (Days)</th>
                        <th>DoH</th>
                        <th>Usage/Day</th>
                        <th>Remark</th>
                    </tr>
                </thead>
                <tbody id="warehouse-table-body"></tbody>
            </table>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        // BKK API URL (Google Apps Script Web App)
        const BKK_API_URL = "https://script.google.com/macros/s/AKfycbz2wj7NG3uyvz-H152h4zAVcfm9Rh5sr4d73kZOw3hYT1BfeVkVWKwI7sTK6mXl1UoL/exec?type=bkk";

        // Fallback dummy data for testing
        const dummyData = {
            warehouses: ["BULK A", "BULK B", "BULK C", "FLAT 1", "FLAT 2", "FLAT 3"],
            capacities: [500000, 500000, 600000, 1000000, 1000000, 800000],
            materials: [
                { name: "PK", supplier: "PT. ABC", warehouse: "BULK A", stock: 450000, capacity: 500000, percentage: 90, age: 12, remark: "FAST MOVE", usageDaily: 86000, doh: 5.2 },
                { name: "PK", supplier: "PT. XYZ", warehouse: "BULK B", stock: 120000, capacity: 500000, percentage: 24, age: 4, remark: "INCOMING", usageDaily: 86000, doh: 1.4 },
                { name: "PKS", supplier: "PT. DEF", warehouse: "BULK C", stock: 380000, capacity: 600000, percentage: 63, age: 15, remark: "STABLE", usageDaily: 78000, doh: 4.8 },
                { name: "PK", supplier: "EXTERNAL", warehouse: "FLAT 1", stock: 850000, capacity: 1000000, percentage: 85, age: 22, remark: "HIGH STOCK", usageDaily: 86000, doh: 9.8 },
                { name: "PKS", supplier: "PT. GHI", warehouse: "FLAT 2", stock: 720000, capacity: 1000000, percentage: 72, age: 18, remark: "NORMAL", usageDaily: 78000, doh: 9.2 },
                { name: "PK", supplier: "PT. JKL", warehouse: "FLAT 3", stock: 560000, capacity: 800000, percentage: 70, age: 10, remark: "ACTIVE", usageDaily: 86000, doh: 6.5 }
            ]
        };

        async function fetchBKKData() {
            if (!BKK_API_URL) {
                console.warn("BKK_API_URL not set, using dummy data");
                return dummyData;
            }

            try {
                const response = await fetch(BKK_API_URL + "?t=" + new Date().getTime());
                const data = await response.json();
                if (data.error) {
                    console.error("API Error:", data.error);
                    return dummyData;
                }
                return data;
            } catch (error) {
                console.error("Fetch error:", error);
                return dummyData;
            }
        }

        function renderDashboard(data) {
            // 1. Calculate width scaling based on capacity
            const maxCapacity = Math.max(...data.materials.map(m => m.capacity || 0));
            const minWidth = 120;
            const maxWidth = 240;

            // 2. Render Visual Grid
            const visualGrid = document.getElementById('warehouse-visual-grid');
            visualGrid.innerHTML = '';

            data.materials.forEach((item) => {
                // Calculate percentage from stock/capacity if not provided
                let pct = item.percentage || 0;
                if (item.stock && item.capacity && item.capacity > 0) {
                    pct = (item.stock / item.capacity) * 100;
                }
                pct = Math.min(100, Math.max(0, pct));

                // Calculate dynamic width based on capacity ratio
                const widthRatio = (item.capacity || 0) / maxCapacity;
                const dynamicWidth = minWidth + (widthRatio * (maxWidth - minWidth));

                const card = document.createElement('div');
                card.className = 'warehouse-unit';
                card.innerHTML = `
                    <div class="warehouse-visual" style="width: ${dynamicWidth}px;">
                        <div class="warehouse-shine"></div>
                        <div class="warehouse-fill" style="height:${pct}%"></div>
                    </div>
                    
                    <div class="warehouse-info-card" style="width: ${dynamicWidth}px;">
                        <div class="warehouse-name-label">${item.warehouse || item.name}</div>
                        <div class="warehouse-big-percent">${pct.toFixed(1)}%</div>
                        
                        <div class="warehouse-data-row" style="font-size: 0.7rem; color: #10b981;">
                            <span>${item.name || 'N/A'}</span>
                        </div>
                        <div class="warehouse-data-row" style="font-size: 0.65rem; color: #64748b; margin-bottom: 4px;">
                            <span>${item.supplier || '-'}</span>
                        </div>
                        
                        <div class="warehouse-data-row">
                            <span>S: ${((item.stock || 0) / 1000).toLocaleString('id-ID', { maximumFractionDigits: 1 })} T</span>
                            <span>C: ${((item.capacity || 0) / 1000).toLocaleString('id-ID', { maximumFractionDigits: 1 })} T</span>
                        </div>
                        <div class="warehouse-data-row" style="justify-content:center; margin-top:5px;">
                            Age: ${item.age || 0} Days
                        </div>
                        
                        ${item.remark && item.remark !== 'IDLE' && item.remark !== '' ? `<div class="remark-badge">${item.remark}</div>` : ''}
                    </div>
                `;
                visualGrid.appendChild(card);
            });

            // 3. Render Table
            const tbody = document.getElementById('warehouse-table-body');
            tbody.innerHTML = '';

            data.materials.forEach(item => {
                // Calculate actual percentage from stock/capacity
                let pct = item.percentage || 0;
                if (item.stock && item.capacity && item.capacity > 0) {
                    pct = (item.stock / item.capacity) * 100;
                }
                pct = Math.min(100, Math.max(0, pct));

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.warehouse}</td>
                    <td style="color:#10b981; font-weight:700;">${item.name}</td>
                    <td style="color:#64748b;">${item.supplier}</td>
                    <td style="color:${item.stock === 0 ? '#ef4444' : '#4ade80'}">${item.stock?.toLocaleString()}</td>
                    <td>${item.capacity?.toLocaleString()}</td>
                    <td>
                        <div class="percent-bar-bg">
                            <div class="percent-bar-fill" style="width:${pct}%;"></div>
                        </div>
                    </td>
                    <td>${item.age}</td>
                    <td style="color:#10b981;">${item.doh}</td>
                    <td>${item.usageDaily?.toLocaleString()}</td>
                    <td style="color:${item.remark !== 'IDLE' ? '#10b981' : '#64748b'}">${item.remark}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Initialize
        (async function () {
            const data = await fetchBKKData();
            renderDashboard(data);

            // Auto-refresh every 30 seconds if API is configured
            if (BKK_API_URL) {
                setInterval(async () => {
                    const freshData = await fetchBKKData();
                    renderDashboard(freshData);
                }, 30000);
            }
        })();
    </script>
</body>

</html>