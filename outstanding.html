<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPI WAREHOUSE - Outstanding Monitoring</title>

    <!-- FONTS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@500;700&display=swap"
        rel="stylesheet">

    <!-- STYLES -->
    <link rel="stylesheet" href="css/rm_stock_v2.css">
    <link rel="stylesheet" href="homepage-style.css">

    <style>
        body {
            background-color: #050505;
            color: #fff;
            overflow-x: hidden;
        }

        .navbar {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: sticky;
            top: 0;
            background: rgba(5, 5, 5, 0.95);
            z-index: 1000;
        }

        .outstanding-container {
            padding: 40px 60px;
            max-width: 1800px;
            margin: 0 auto;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-family: 'Orbitron';
            font-size: 2rem;
            color: #fff;
            letter-spacing: 3px;
            margin-bottom: 10px;
        }

        .page-subtitle {
            font-family: 'Rajdhani';
            color: #64748b;
            font-size: 0.9rem;
            letter-spacing: 2px;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(15, 23, 42, 0.9), rgba(10, 10, 10, 0.95));
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-left: 3px solid #3b82f6;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.6);
        }

        .stat-label {
            font-family: 'Orbitron';
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-family: 'Rajdhani';
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
        }

        .stat-unit {
            font-size: 0.9rem;
            color: #64748b;
            margin-left: 5px;
        }

        /* MATERIAL BREAKDOWN */
        .material-section {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .section-title {
            font-family: 'Orbitron';
            font-size: 1.2rem;
            color: #fff;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .material-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
        }

        .material-card {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.2s;
        }

        .material-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.2);
        }

        .material-name {
            font-family: 'Orbitron';
            font-size: 1rem;
            color: #3b82f6;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .material-stats {
            display: flex;
            justify-content: space-between;
            font-family: 'Rajdhani';
            font-size: 0.85rem;
            color: #cbd5e1;
            margin-bottom: 5px;
        }

        .material-stats .label {
            color: #64748b;
        }

        .material-stats .value {
            font-weight: 700;
        }

        /* DATA TABLE */
        .data-table-container {
            background: rgba(10, 10, 10, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            font-family: 'Orbitron';
            font-size: 0.7rem;
            color: #64748b;
            text-align: left;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-transform: uppercase;
        }

        .data-table td {
            font-family: 'Rajdhani';
            font-size: 0.9rem;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
            color: #cbd5e1;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-inap {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid #ef4444;
        }

        .badge-normal {
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid #22c55e;
        }
    </style>
</head>

<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="nav-brand">
            <div class="logo-icon">üè≠</div>
            <div class="logo-text">CPI WAREHOUSE</div>
        </div>

        <div class="nav-links">
            <a href="homepage-v1.html" class="nav-link">HOME</a>
            <a href="rm-dashboard.html" class="nav-link">RM-STORAGE</a>
            <a href="cpo-dashboard.html" class="nav-link"
                style="color:#ff9e0b; text-shadow:0 0 10px rgba(255,158,11,0.5);">CPO</a>
            <a href="bkk-dashboard.html" class="nav-link"
                style="color:#10b981; text-shadow:0 0 10px rgba(16,185,129,0.5);">BKK</a>
            <a href="about-page.html" class="nav-link">ABOUT</a>
            <a href="outstanding.html" class="nav-link active"
                style="color:#3b82f6; text-shadow:0 0 10px rgba(59,130,246,0.5);">OUTSTANDING</a>
        </div>
    </nav>

    <!-- CONTENT -->
    <div class="outstanding-container">

        <div class="page-header">
            <div class="page-title">OUTSTANDING MONITORING</div>
            <div class="page-subtitle">BONGKARAN REAL-TIME ANALYTICS</div>
        </div>

        <!-- GLOBAL STATS -->
        <div class="stats-grid" id="global-stats">
            <!-- Injected by JS -->
        </div>

        <!-- MATERIAL BREAKDOWN -->
        <div class="material-section">
            <div class="section-title">üìä BREAKDOWN PER MATERIAL</div>
            <div class="material-grid" id="material-breakdown">
                <!-- Injected by JS -->
            </div>
        </div>

        <!-- DETAILED DATA TABLE -->
        <div class="data-table-container">
            <div class="section-title">üìã DETAILED MONITORING DATA</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>No Sequence</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Material</th>
                        <th>Netto (KG)</th>
                        <th>Truck Type</th>
                        <th>Aging Status</th>
                    </tr>
                </thead>
                <tbody id="data-table-body">
                    <!-- Injected by JS -->
                </tbody>
            </table>
        </div>

        <!-- PLACEMENT REFERENCE SECTION -->
        <div class="data-table-container" style="margin-top: 30px;">
            <div class="section-title">üìç ACUAN PENEMPATAN BONGKARAN</div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th rowspan="2">Acuan</th>
                        <th rowspan="2">Grade</th>
                        <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">OPSI
                            1</th>
                        <th colspan="3" style="text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1);">OPSI
                            2</th>
                    </tr>
                    <tr>
                        <th>Gudang</th>
                        <th>Lot</th>
                        <th>Qty</th>
                        <th>Gudang</th>
                        <th>Lot</th>
                        <th>Qty</th>
                    </tr>
                </thead>
                <tbody id="placement-table-body">
                    <!-- Injected by JS -->
                </tbody>
            </table>
        </div>

    </div>

    <!-- SCRIPT -->
    <script>
        // PASTE YOUR DEPLOYED GOOGLE APPS SCRIPT WEB APP URL HERE
        const OUTSTANDING_API_URL = "https://script.google.com/macros/s/AKfycbwXIxVTx7oMLlzrQWams1ArxJxJnJhUL37MopO8FQMYfF-Ak_lVZnh2nOInwASqAgku/exec";

        // Dummy data for testing
        const dummyData = {
            monitoring: [
                { sequence: "B-9937-SYL", date: "03.02.2026", status: "QC not yet performed", material: "PKM", netto: 22000, truckType: "DUMPT TRUCK", agingStatus: "INPUTAN HARI INI" },
                { sequence: "E-9528-AF", date: "03.02.2026", status: "QC not yet performed", material: "PKM", netto: 22000, truckType: "DUMPT TRUCK", agingStatus: "INPUTAN HARI INI" },
                { sequence: "B-1234-XY", date: "02.02.2026", status: "Ready", material: "PKS", netto: 18000, truckType: "FUSO", agingStatus: "NORMAL" }
            ],
            placement: [
                { acuan: "PKM A", grade: "A", option1: { gudang: "GD-1", lot: "LOT-001", qty: 50000 }, option2: { gudang: "GD-2", lot: "LOT-002", qty: 30000 } },
                { acuan: "PKM B", grade: "B", option1: { gudang: "GD-3", lot: "LOT-003", qty: 40000 }, option2: { gudang: "GD-4", lot: "LOT-004", qty: 25000 } }
            ]
        };

        async function fetchOutstandingData() {
            if (!OUTSTANDING_API_URL) {
                console.warn("OUTSTANDING_API_URL not set, using dummy data");
                return dummyData;
            }

            console.log("Fetching from URL:", OUTSTANDING_API_URL);

            try {
                const response = await fetch(OUTSTANDING_API_URL + "&t=" + new Date().getTime());
                const data = await response.json();

                console.log("API Response:", data);

                if (data.error) {
                    console.error("API Error:", data.error);
                    return dummyData;
                }
                return data;
            } catch (error) {
                console.error("Fetch error:", error);
                return dummyData;
            }
        }

        function renderDashboard(data) {
            // Safety check
            if (!data || !data.monitoring || !Array.isArray(data.monitoring)) {
                console.error("Invalid data structure:", data);
                return;
            }

            // Filter out empty items
            const validItems = data.monitoring.filter(item => item.material && item.material !== "");

            // 1. Calculate Global Stats
            const totalTrucks = validItems.length;
            const totalNetto = validItems.reduce((sum, item) => sum + (parseFloat(item.netto) || 0), 0);
            const uniqueMaterials = [...new Set(validItems.map(item => item.material))].length;
            const totalInap = validItems.filter(item => item.agingStatus && item.agingStatus.toUpperCase().includes("INAP")).length;

            // Render Global Stats
            const statsContainer = document.getElementById('global-stats');
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Trucks</div>
                    <div class="stat-value">${totalTrucks}<span class="stat-unit">Units</span></div>
                </div>
                <div class="stat-card" style="border-left-color: #10b981;">
                    <div class="stat-label">Total Netto</div>
                    <div class="stat-value">${(totalNetto / 1000).toLocaleString('id-ID', { maximumFractionDigits: 2 })}<span class="stat-unit">TON</span></div>
                </div>
                <div class="stat-card" style="border-left-color: #f59e0b;">
                    <div class="stat-label">Unique Materials</div>
                    <div class="stat-value">${uniqueMaterials}<span class="stat-unit">Types</span></div>
                </div>
                <div class="stat-card" style="border-left-color: #ef4444;">
                    <div class="stat-label">Trucks Inap</div>
                    <div class="stat-value">${totalInap}<span class="stat-unit">Units</span></div>
                </div>
            `;

            // 2. Material Breakdown
            const materialMap = {};
            validItems.forEach(item => {
                const mat = item.material;
                if (!materialMap[mat]) {
                    materialMap[mat] = { count: 0, totalQty: 0, inap: 0 };
                }
                materialMap[mat].count++;
                materialMap[mat].totalQty += parseFloat(item.netto) || 0;
                if (item.agingStatus && item.agingStatus.toUpperCase().includes("INAP")) {
                    materialMap[mat].inap++;
                }
            });

            const breakdownContainer = document.getElementById('material-breakdown');
            breakdownContainer.innerHTML = '';
            Object.keys(materialMap).forEach(mat => {
                const stats = materialMap[mat];
                const card = document.createElement('div');
                card.className = 'material-card';
                card.innerHTML = `
                    <div class="material-name">${mat}</div>
                    <div class="material-stats">
                        <span class="label">Trucks:</span>
                        <span class="value">${stats.count} Units</span>
                    </div>
                    <div class="material-stats">
                        <span class="label">Total Netto:</span>
                        <span class="value">${(stats.totalQty / 1000).toLocaleString('id-ID', { maximumFractionDigits: 2 })} TON</span>
                    </div>
                    <div class="material-stats">
                        <span class="label">Inap:</span>
                        <span class="value" style="color: ${stats.inap > 0 ? '#ef4444' : '#22c55e'};">${stats.inap} Units</span>
                    </div>
                `;
                breakdownContainer.appendChild(card);
            });

            // 3. Data Table
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = '';
            validItems.forEach(item => {
                const isInap = item.agingStatus && item.agingStatus.toUpperCase().includes("INAP");
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td style="font-family: 'Orbitron'; font-size: 0.85rem;">${item.sequence || '-'}</td>
                    <td>${item.date || '-'}</td>
                    <td style="color: #cbd5e1; font-size: 0.85rem;">${item.status || '-'}</td>
                    <td style="color: #3b82f6; font-weight: 700;">${item.material}</td>
                    <td style="font-weight: 700;">${parseFloat(item.netto || 0).toLocaleString('id-ID')}</td>
                    <td>${item.truckType}</td>
                    <td><span class="badge ${isInap ? 'badge-inap' : 'badge-normal'}">${item.agingStatus}</span></td>
                `;
                tbody.appendChild(row);
            });

            // 4. Placement Reference Table
            if (data.placement && Array.isArray(data.placement)) {
                const placementTbody = document.getElementById('placement-table-body');
                placementTbody.innerHTML = '';
                data.placement.forEach(item => {
                    if (!item.acuan || item.acuan === "") return;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="color: #3b82f6; font-weight: 700;">${item.acuan}</td>
                        <td>${item.grade || '-'}</td>
                        <td>${item.option1.gudang || '-'}</td>
                        <td>${item.option1.lot || '-'}</td>
                        <td style="font-weight: 700;">${parseFloat(item.option1.qty || 0).toLocaleString('id-ID')}</td>
                        <td>${item.option2.gudang || '-'}</td>
                        <td>${item.option2.lot || '-'}</td>
                        <td style="font-weight: 700;">${parseFloat(item.option2.qty || 0).toLocaleString('id-ID')}</td>
                    `;
                    placementTbody.appendChild(row);
                });
            }
        }

        // Initialize
        (async function () {
            const data = await fetchOutstandingData();
            renderDashboard(data);

            // Auto-refresh every 30 seconds if API is configured
            if (OUTSTANDING_API_URL) {
                setInterval(async () => {
                    const freshData = await fetchOutstandingData();
                    renderDashboard(freshData);
                }, 30000);
            }
        })();
    </script>

</body>

</html>