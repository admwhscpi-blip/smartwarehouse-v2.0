<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- PWA / MOBILE APP MODE -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#03040b">
    <meta name="application-name" content="WHSMART">
    <meta name="apple-mobile-web-app-title" content="WHSMART">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2942/2942544.png">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2942/2942544.png">

    <title>WHSMART v18.18 - MOBILE APP MODE</title>

    <!-- UI LIBS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/dark.css">
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

    <style>
        :root {
            --bg: #03040b;
            --card: rgba(15, 20, 35, 0.7);
            --accent: #00f3ff;
            --accent-glow: rgba(0, 243, 255, 0.4);
            --text: #ffffff;
            --muted: #a0a0c0;
            --success: #00ff88;
            --border: rgba(0, 243, 255, 0.2);
            --danger: #ff4d4d;
            --warning: #ffaa00;
        }

        body {
            background-color: var(--bg);
            background-image: radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.05) 0%, transparent 40%);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            /* v18.28: Prevent Scroll Zoom */
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
            /* v18.25: Full Width Mobile */
            box-sizing: border-box;
        }

        .app-bar {
            background: rgba(5, 7, 15, 0.95);
            padding: 20px 0;
            text-align: center;
            border-bottom: 2px solid var(--accent);
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 30px rgba(0, 243, 255, 0.2);
        }

        .brand-logo {
            font-family: 'Orbitron';
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 5px;
            cursor: pointer;
            transition: 0.4s;
            display: inline-block;
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .brand-logo:hover {
            transform: scale(1.05);
            text-shadow: 0 0 15px var(--accent-glow);
        }

        .brand-logo span {
            color: var(--accent);
            text-shadow: 0 0 10px var(--accent-glow);
        }

        .app-sub {
            font-family: 'Orbitron';
            font-size: 0.5rem;
            color: var(--muted);
            letter-spacing: 1px;
            margin-top: 4px;
            pointer-events: none;
        }

        .screen {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-card {
            background: var(--card);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .section-header {
            font-family: 'Orbitron';
            font-size: 0.65rem;
            color: var(--accent);
            margin: 20px 0 12px 0;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 0 0 5px var(--accent-glow);
            text-transform: uppercase;
        }

        .section-header::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--border), transparent);
        }

        .field-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            /* v18.25: Bigger Label */
            color: var(--muted);
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 1px;
        }

        input,
        select {
            width: 100%;
            background: rgba(20, 25, 45, 0.8);
            border: 1px solid var(--border);
            color: white;
            padding: 14px;
            /* v18.25: Larger Touch Area */
            border-radius: 12px;
            font-size: 1rem;
            /* v18.25: No Auto-Zoom iOS */
            font-family: 'Inter';
            box-sizing: border-box;
            -webkit-appearance: none;
            /* Mobile reset */
        }

        input:focus,
        select:focus {
            border-color: var(--accent);
            outline: none;
        }

        .input-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Role Selection */
        .selection-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-top: 25px;
        }

        .selection-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            text-align: left;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            overflow: hidden;
        }

        .selection-card:hover {
            border-color: var(--accent);
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(0, 243, 255, 0.1);
        }

        .selection-icon {
            font-size: 2.2rem;
            min-width: 60px;
            text-align: center;
        }

        .selection-title {
            font-family: 'Orbitron';
            font-size: 0.75rem;
            color: var(--accent);
            margin-bottom: 4px;
            font-weight: 700;
        }

        .selection-desc {
            font-size: 0.55rem;
            color: var(--muted);
        }

        /* Task Center List */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .task-card {
            background: rgba(30, 40, 60, 0.4);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            cursor: pointer;
            transition: 0.2s;
            border-left: 4px solid var(--warning);
        }

        .task-card:hover {
            transform: scale(1.01);
            border-color: var(--accent);
            background: rgba(0, 243, 255, 0.05);
        }

        .task-card.coord {
            border-left-color: var(--accent);
        }

        .task-card .nopol {
            font-family: 'Orbitron';
            color: var(--accent);
            font-size: 0.85rem;
            font-weight: 700;
        }

        .task-card .mat {
            font-size: 0.65rem;
            color: var(--text);
            margin-top: 4px;
        }

        .task-card .status {
            display: inline-block;
            font-size: 0.45rem;
            background: var(--warning);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 800;
            margin-top: 5px;
        }

        /* Buttons */
        .btn-submit {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, var(--accent), #00aaff);
            color: #000;
            border: none;
            border-radius: 15px;
            font-family: 'Orbitron';
            font-weight: 800;
            font-size: 0.9rem;
            letter-spacing: 2px;
            box-shadow: 0 10px 20px rgba(0, 243, 255, 0.3);
            cursor: pointer;
        }

        .btn-submit:disabled {
            background: #334155 !important;
            color: #64748b !important;
            cursor: not-allowed;
            box-shadow: none;
            border: 1px solid var(--border);
        }

        /* LOADING SPINNER */
        .loading-spinner-inline {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0, 0, 0, 0.3);
            border-radius: 50%;
            border-top-color: #000;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* FORM SECTION HEADERS */
        .form-section {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .form-section-header {
            font-family: 'Orbitron';
            font-size: 0.65rem;
            color: var(--accent);
            letter-spacing: 2px;
            padding-bottom: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-section-header .section-badge {
            background: rgba(0, 243, 255, 0.15);
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 0.5rem;
            color: var(--accent);
        }

        .truck-card {
            background: rgba(40, 50, 80, 0.3);
            padding: 18px;
            border-radius: 15px;
            margin-bottom: 12px;
            border: 1px dashed var(--border);
            position: relative;
        }

        .truck-card-header {
            font-family: 'Orbitron';
            font-size: 0.7rem;
            color: #00f3ff;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(0, 243, 255, 0.15);
            letter-spacing: 1px;
        }

        .btn-add-unit {
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.1), rgba(0, 102, 255, 0.15));
            border: 2px dashed var(--accent);
            color: var(--accent);
            width: 100%;
            padding: 20px;
            border-radius: 15px;
            font-family: 'Orbitron';
            font-size: 0.85rem;
            font-weight: 700;
            margin: 15px 0;
            cursor: pointer;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        .btn-add-unit:hover {
            background: linear-gradient(135deg, rgba(0, 243, 255, 0.2), rgba(0, 102, 255, 0.25));
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            transform: scale(1.02);
        }

        /* TOM SELECT TWEAKS */
        .ts-dropdown .option {
            color: #000 !important;
            font-weight: 600;
            background: #fff !important;
            border-bottom: 1px solid #eee;
        }

        .ts-dropdown .active {
            background: var(--accent) !important;
            color: #000 !important;
        }

        .ts-control input {
            color: #000 !important;
        }

        .ts-control {
            background: rgba(20, 25, 45, 0.8) !important;
            border: 1px solid var(--border) !important;
            color: white !important;
        }

        .ts-control .item {
            color: white !important;
        }

        .btn-back {
            background: none;
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 8px 12px;
            border-radius: 10px;
            font-family: 'Orbitron';
            font-size: 0.6rem;
            margin-bottom: 20px;
            cursor: pointer;
        }

        .btn-new {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            font-family: 'Orbitron';
            font-size: 0.7rem;
            margin-top: 10px;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Overlay */
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .success-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        #data-status-box {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.7rem;
            font-family: 'Orbitron';
            color: var(--muted);
            border: 1px solid var(--border);
            z-index: 500;
        }

        /* v18.28: CRITICAL BREAKPOINT FIX */
        @media (max-width: 768px) {

            .input-grid,
            .selection-grid,
            .mode-grid {
                grid-template-columns: 1fr !important;
                /* Stack vertically */
                gap: 15px;
            }

            .container {
                padding: 10px;
                width: 100%;
            }

            .app-bar {
                padding: 15px 0;
            }

            .brand-logo {
                font-size: 1.2rem;
            }

            .app-sub {
                font-size: 0.65rem;
            }

            .btn-submit,
            .btn-new {
                padding: 20px;
                font-size: 1rem;
            }

            .selection-icon {
                font-size: 2.5rem;
            }

            .selection-title {
                font-size: 1rem;
            }

            .selection-desc {
                font-size: 0.8rem;
            }

            .task-card .nopol {
                font-size: 1.1rem;
            }

            .task-card .mat {
                font-size: 0.85rem;
            }

            .section-header {
                font-size: 0.9rem;
            }

            /* v19.7: Cyberpunk Checkbox */
            .cyber-checkbox-label {
                position: relative;
                cursor: pointer;
                font-family: 'Orbitron', sans-serif;
                font-size: 0.7rem;
                font-weight: bold;
                color: var(--muted);
                transition: 0.3s;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 8px 15px;
                border: 1px solid var(--border);
                border-radius: 4px;
                background: rgba(0, 0, 0, 0.5);
                min-width: 100px;
                text-align: center;
                letter-spacing: 1px;
            }

            .cyber-checkbox-input {
                display: none;
            }

            .cyber-checkbox-text-checked {
                display: none;
                color: var(--success);
                text-shadow: 0 0 10px var(--success);
            }

            .cyber-checkbox-text-unchecked {
                display: inline;
            }

            .cyber-checkbox-input:checked~.cyber-checkbox-text-checked {
                display: inline;
            }

            .cyber-checkbox-input:checked~.cyber-checkbox-text-unchecked {
                display: none;
            }

            .cyber-checkbox-label:has(input:checked) {
                border-color: var(--success);
                background: rgba(0, 255, 136, 0.1);
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
            }

            /* Fallback for browsers not supporting :has */
            .cyber-checkbox-label.active {
                border-color: var(--success);
                background: rgba(0, 255, 136, 0.1);
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
            }

            .crosscheck-item {
                transition: 0.3s;
            }

            .crosscheck-item.checked {
                border-color: var(--success) !important;
                background: rgba(0, 255, 136, 0.05) !important;
                box-shadow: 0 0 15px rgba(0, 255, 136, 0.1);
            }
    </style>
</head>

<body>
    <div id="data-status-box">CLOUD DATA: <span id="data-status-label" style="color:var(--danger)">OFFLINE</span></div>

    <div class="success-overlay" id="success-overlay">
        <div style="font-size: 4rem; margin-bottom: 10px;">üõ°Ô∏è</div>
        <h2 style="font-family: 'Orbitron'; color: var(--success);">SYNC SUCCESS</h2>
        <p id="success-msg" style="color: var(--muted);">v18.3 Ultimate Synchronization Success.</p>
        <button class="btn-submit" style="width: auto; padding: 15px 40px;" onclick="location.reload()">SIAAP
            GGMU!</button>
    </div>

    <!-- EDIT OVERLAY (Unified for Krani/Coord) -->
    <div class="overlay" id="edit-screen">
        <div class="container">
            <button class="btn-back" onclick="closeEdit()">‚Üê BATAL / BALIK</button>
            <div class="form-card">
                <div class="section-header" id="edit-header">LENGKAPI DATA</div>
                <div id="edit-summary"
                    style="margin-bottom: 20px; padding: 15px; background: rgba(0,243,255,0.05); border-radius: 12px; border: 1px solid var(--border);">
                    <div id="edit-nopol" style="font-family:'Orbitron'; color:var(--accent); font-size:1.1rem;">-</div>
                    <div id="edit-mat" style="font-size: 0.7rem; color:white; margin-top:5px;">-</div>
                    <div id="edit-gudang" style="font-size: 0.6rem; color:var(--muted); margin-top:3px;">-</div>
                </div>

                <div id="krani-edit-fields" style="display:none;">
                    <div class="field-group">
                        <label>Input Netto Baru (Kg)</label>
                        <input type="number" id="edit_netto" placeholder="Kg">
                    </div>
                </div>

                <div id="coord-edit-fields" style="display:none;">
                    <div class="field-group"><label>1. Arrival Date</label><input type="text" id="coord_arrival_date"
                            class="date-picker"></div>
                    <div class="field-group"><label>2. Arrival Time</label><input type="text" id="coord_arrival_time"
                            class="time-picker"></div>
                    <div class="field-group"><label>3. QC Sampling 1 Time</label><input type="text" id="coord_qc_time"
                            class="time-picker"></div>
                    <div class="field-group"><label>4. Time Timbang Masuk</label><input type="text"
                            id="coord_timbang_time" class="time-picker"></div>
                </div>

                <input type="hidden" id="edit-row-id">
                <button class="btn-submit" id="btn-update-task" onclick="submitTaskUpdate()">SINKRONISASI DATA PETUGAS
                    üöÄ</button>
            </div>
        </div>
    </div>

    <!-- APP BAR (v18.25 MOBILE OPTIMIZED) -->
    <div class="app-bar">
        <div class="brand-logo" onclick="handleLogoClick()">SMART <span>WAREHOUSE</span></div>
        <div class="app-sub">v18.25 MOBILE OPTIMIZED - SAT SET GGMU!</div>
    </div>

    <div class="container">

        <!-- SCREEN 0: ROLE SELECTION -->
        <div id="screen-role" class="screen active">
            <h3
                style="font-family: 'Orbitron'; font-size: 0.65rem; color: var(--accent); text-align: center; margin-top: 30px; letter-spacing: 3px;">
                PILIH ROLE / AKTIVITAS</h3>
            <div class="selection-grid">
                <div class="selection-card" onclick="switchScreen('setup')">
                    <div class="selection-icon">‚öôÔ∏è</div>
                    <div class="selection-content">
                        <div class="selection-title">SETUP AWAL SHIFT</div>
                        <div class="selection-desc">Config Nama Krani & Koordinator.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="openSessionPicker('input')">
                    <div class="selection-icon">üöö</div>
                    <div class="selection-content">
                        <div class="selection-title">KRANI BONGKARAN</div>
                        <div class="selection-desc">Mulai pencatatan truck baru.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="switchScreen('muat-choice')">
                    <div class="selection-icon">üì¶</div>
                    <div class="selection-content">
                        <div class="selection-title">KRANI MUATAN</div>
                        <div class="selection-desc">Input data muatan / loading truck.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="switchTaskChoice()">
                    <div class="selection-icon">üîç</div>
                    <div class="selection-content">
                        <div class="selection-title">LENGKAPI DATA (RESUME)</div>
                        <div class="selection-desc">Lanjutkan sesi yang tertunda.</div>
                        <div class="selection-desc" style="color:var(--accent); font-size:0.55rem; margin-top:5px;">
                            *Termasuk KOORDINATOR</div>
                    </div>
                </div>
            </div>


            <div style="text-align:center; margin-top:30px;">
                <!-- v18.32: Dashboard Button -->
                <a href="homepage-v1.html" style="text-decoration:none;">
                    <button style="
                        background: rgba(255, 255, 255, 0.1);
                        border: 1px solid var(--border);
                        color: var(--muted);
                        padding: 12px 25px;
                        border-radius: 50px;
                        font-family: 'Orbitron';
                        font-size: 0.7rem;
                        cursor: pointer;
                        display: inline-block;
                        margin-bottom: 15px;
                    ">
                        ‚Üê KEMBALI KE DASHBOARD
                    </button>
                </a>
                <br>
                <button id="btn-install-app" onclick="installApp()" style="
                    background: linear-gradient(90deg, #00f3ff, #0066ff);
                    color: #000;
                    border: none;
                    padding: 12px 25px;
                    border-radius: 50px;
                    font-family: 'Orbitron';
                    font-weight: bold;
                    font-size: 0.8rem;
                    cursor: pointer;
                    box-shadow: 0 0 15px rgba(0, 243, 255, 0.4);
                    display: inline-block; /* v18.21: Force Visible */
                    animation: pulse 2s infinite;
                ">
                    üì≤ INSTALL APLIKASI
                </button>
                <p id="install-instruction"
                    style="color:var(--muted); font-size:0.7rem; margin-top:10px; opacity:0.6; display:none;">
                    *Jika tombol tidak muncul, gunakan menu Browser (‚ãÆ) -> Tambahkan ke Layar Utama
                </p>
            </div>
        </div>

        <!-- SCREEN: SESSION PICKER (v16.5) -->
        <div id="screen-session-picker" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê GANTI ROLE</button>
            <div class="section-header">LANJUTKAN SESI?</div>
            <div id="session-list" style="margin-bottom:20px;">
                <div style="text-align:center; padding:20px; color:var(--muted);">MENCARI SESI AKTIF...</div>
            </div>
            <div style="text-align:center; margin-top:20px;">
                <button onclick="switchScreen('setup')" style="
                    background: linear-gradient(135deg, #00f3ff, #0066ff, #7b2fff);
                    color: #fff;
                    border: none;
                    width: 100%;
                    padding: 18px;
                    border-radius: 15px;
                    font-family: 'Orbitron';
                    font-weight: 800;
                    font-size: 0.95rem;
                    letter-spacing: 2px;
                    cursor: pointer;
                    box-shadow: 0 0 25px rgba(0, 243, 255, 0.5), 0 0 50px rgba(0, 102, 255, 0.2);
                    text-transform: uppercase;
                    text-shadow: 0 1px 3px rgba(0,0,0,0.4);
                    transition: all 0.3s ease;
                ">‚öôÔ∏è BUAT SETUP BARU</button>
            </div>
        </div>

        <!-- SCREEN 1: SETUP IDENTITY -->
        <div id="screen-setup" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê BALIK KE HOME</button>
            <div class="form-card">
                <div class="section-header">SETUP AWAL SHIFT (LENGKAP)</div>
                <div class="input-grid">
                    <div class="field-group"><label>Shift</label><select id="setup_shift">
                            <option value="1">SHIFT 1</option>
                            <option value="2">SHIFT 2</option>
                            <option value="3">SHIFT 3</option>
                        </select></div>
                    <div class="field-group"><label>SLOC</label>
                        <select id="setup_sloc">
                            <option value="" disabled selected>-- PILIH SLOC --</option>
                            <option value="RW01">RW01</option>
                            <option value="RW03">RW03</option>
                            <option value="RM01">RM01</option>
                        </select>
                    </div>
                </div>
                <div class="field-group"><label>Nama Krani Petugas</label><input type="text" id="setup_krani"
                        placeholder="Nama Krani (Abi Fajar dll)"></div>
                <div class="field-group"><label>Nama Koordinator (PILIH)</label>
                    <select id="setup_coordinator">
                        <option value="" disabled selected>-- PILIH NAMA --</option>
                        <option value="HADI">HADI</option>
                        <option value="ADE YANTO">ADE YANTO</option>
                        <option value="SAFII">SAFII</option>
                    </select>
                </div>
                <div class="field-group"><label>Sampling Man</label><input type="text" id="setup_sampling"
                        placeholder="Nama Sampling Man"></div>
                <div class="input-grid">
                    <div class="field-group"><label>Tim Kerja BORONG</label>
                        <select id="setup_tim_borong">
                            <option value="BADRUN">BADRUN</option>
                            <option value="KARTONO">KARTONO</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Tim Kerja HARIAN</label>
                        <select id="setup_tim_harian">
                            <option value="WAWAN">WAWAN</option>
                            <option value="SURYANA">SURYANA</option>
                            <option value="SAHLAN">SAHLAN</option>
                        </select>
                    </div>
                </div>
                <button class="btn-submit" onclick="saveSession()">SIMPAN SETUP üõ°Ô∏è</button>
            </div>
        </div>

        <!-- SCREEN: TASK CHOICE (Rule 6) -->
        <div id="screen-task-choice" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê BALIK KE HOME</button>
            <h3
                style="font-family:'Orbitron'; font-size:0.7rem; color:var(--accent); text-align:center; margin-bottom:20px;">
                LENGKAPI DATA SEBAGAI</h3>
            <div class="selection-grid">
                <div class="selection-card" onclick="openSessionPicker('task-krani')">
                    <div class="selection-icon">üöö</div>
                    <div class="selection-content">
                        <div class="selection-title">REDAKSI KRANI</div>
                        <div class="selection-desc">Lengkapi Tonase Netto.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="openSessionPicker('task-coord')">
                    <div class="selection-icon">üìä</div>
                    <div class="selection-content">
                        <div class="selection-title">KORDINATOR</div>
                        <div class="selection-desc">Lengkapi Arrival & QC.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: ACTIVITY CHOICE (v13.2) -->
        <div id="screen-choice" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê GANTI ROLE</button>
            <h3 id="choice-greeting"
                style="font-family: 'Orbitron'; font-size: 0.65rem; color: var(--accent); text-align: center; margin-top: 10px; letter-spacing: 2px;">
                HALO, PETUGAS</h3>
            <p style="text-align: center; font-size: 0.55rem; color: var(--muted); margin-bottom: 25px;">APA YANG
                INGIN
                ANDA LAKUKAN SEKARANG?</p>

            <div class="selection-grid">
                <div class="selection-card" id="choice-input-card" onclick="handleChoice('input')">
                    <div class="selection-icon">üìù</div>
                    <div class="selection-content">
                        <div class="selection-title">INPUT DATA BARU</div>
                        <div class="selection-desc">Mulai pencatatan truck baru.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="handleChoice('tasks')">
                    <div class="selection-icon">üìë</div>
                    <div class="selection-content">
                        <div class="selection-title" id="task-choice-title">LENGKAPI DATA SAYA</div>
                        <div class="selection-desc" id="task-choice-desc">Cek data yang masih kosong.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 3: TASK CENTER (Personal Queue) -->
        <div id="screen-tasks" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê BALIK KE HOME</button>
            <div class="section-header" id="task-title">TUGAS PENDING SAYA</div>
            <div id="task-list-container" class="task-list">
                <div style="text-align:center; padding: 40px; color:var(--muted);">MENCARI TUGAS...</div>
            </div>

            <div id="krani-actions" style="display:none;">
                <div class="section-header">DATA BARU?</div>
                <button class="btn-new" onclick="switchScreen('mode')">MULAI INPUT TRUCK BARU üöö</button>
            </div>

            <button class="btn-back" onclick="loadTaskQueue()"
                style="width:100%; border-color:var(--accent); color:var(--accent); margin-top:20px;">REFRESH TUGAS
                SAYA
                üîÑ</button>
        </div>

        <!-- SCREEN 3: MODE (Krani only) -->
        <div id="screen-mode" class="screen">
            <button class="btn-back" onclick="switchScreen('session-picker')">‚Üê BALIK KE PILIH SESI</button>
            <h3
                style="font-family: 'Orbitron'; font-size: 0.75rem; color: var(--accent); text-align: center; margin-bottom: 20px;">
                PILIH MODE BONGKARAN</h3>
            <div class="selection-grid">
                <div class="selection-card" onclick="selectInputMode('single')">
                    <div class="selection-icon">üöö</div>
                    <div class="selection-content">
                        <div class="selection-title">BONGKARAN 1 JENIS</div>
                        <div class="selection-desc">Input 1 truck. Durasi diisi per truck.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="selectInputMode('batch')">
                    <div class="selection-icon">üöõüöõ</div>
                    <div class="selection-content">
                        <div class="selection-title">BONGKARAN BARENG</div>
                        <div class="selection-desc">Durasi diisi 1x di awal, berlaku untuk semua truck.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN: MUAT CHOICE -->
        <div id="screen-muat-choice" class="screen">
            <button class="btn-back" onclick="switchScreen('role')">‚Üê BALIK KE HOME</button>
            <h3
                style="font-family:'Orbitron'; font-size:0.7rem; color:var(--accent); text-align:center; margin-bottom:20px; letter-spacing:3px;">
                KRANI MUATAN</h3>
            <div class="selection-grid">
                <div class="selection-card" onclick="switchScreen('muat-form')">
                    <div class="selection-icon">üöõ</div>
                    <div class="selection-content">
                        <div class="selection-title">KRANI MUAT INPUT DATA</div>
                        <div class="selection-desc">Input data muatan & durasi loading.</div>
                    </div>
                </div>
                <div class="selection-card" onclick="switchScreen('muat-crosscheck'); fetchManualRisip()">
                    <div class="selection-icon">‚úÖ</div>
                    <div class="selection-content">
                        <div class="selection-title">ADMIN CROSSCHECK</div>
                        <div class="selection-desc">Verifikasi data muatan yang sudah masuk.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN: MUAT FORM (INPUT DATA MUATAN) -->
        <div id="screen-muat-form" class="screen">
            <button class="btn-back" onclick="switchScreen('muat-choice')">‚Üê KEMBALI</button>

            <div class="form-section">
                <div class="form-section-header">üì¶ DATA MUATAN <span class="section-badge">WAJIB DIISI</span></div>
                <div class="field-group"><label>Tanggal</label><input type="date" id="muat_tanggal"></div>
                <div class="input-grid">
                    <div class="field-group"><label>Shift</label>
                        <select id="muat_shift">
                            <option value="1">SHIFT 1</option>
                            <option value="2">SHIFT 2</option>
                            <option value="3">SHIFT 3</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Kategori Risip</label>
                        <select id="muat_kategori">
                            <option value="AUTO">AUTO (SYSTEM)</option>
                            <option value="MANUAL">MANUAL (WRITE)</option>
                        </select>
                    </div>
                </div>
                <div class="field-group"><label>Nama Krani Muat</label>
                    <input type="text" id="muat_krani" placeholder="Isi Nama Krani...">
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>Material</label>
                        <select id="muat_material"></select>
                    </div>
                    <div class="field-group"><label>Nopol Truck</label>
                        <input type="text" id="muat_nopol" placeholder="B 1234 XX">
                    </div>
                </div>
                <div class="field-group"><label>Netto (Kg)</label>
                    <input type="number" id="muat_netto" placeholder="Netto">
                </div>
                <div class="field-group"><label>Jumlah Bag</label>
                    <input type="number" id="muat_jumlah_bag" placeholder="Jml Bag">
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>Tim Kuli Harian</label>
                        <select id="muat_tim_harian">
                            <option value="WAWAN">WAWAN</option>
                            <option value="SAHLAN">SAHLAN</option>
                            <option value="SURYANA">SURYANA</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Jumlah Kuli</label>
                        <input type="number" id="muat_jumlah_kuli" value="1" min="1" placeholder="Jumlah kuli">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <div class="form-section-header">‚è±Ô∏è DURASI MUATAN <span class="section-badge">ISI MANUAL</span></div>
                <div class="input-grid">
                    <div class="field-group"><label>1. PROSES BONGKAR STAPEL</label>
                        <input type="text" id="muat_bongkar_stapel" class="time-picker-muat">
                    </div>
                    <div class="field-group"><label>2. START MUAT</label>
                        <input type="text" id="muat_start_muat" class="time-picker-muat">
                    </div>
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>3. FINISH</label>
                        <input type="text" id="muat_finish" class="time-picker-muat">
                    </div>
                    <div class="field-group"><label>4. TRUCK OTW PABRIK</label>
                        <input type="text" id="muat_otw_pabrik" class="time-picker-muat">
                    </div>
                </div>

            </div>

            <button class="btn-submit" onclick="submitMuatData(this)">SINKRON DATA MUATAN üöÄ</button>
        </div>

        <!-- SCREEN: MUAT CROSSCHECK -->
        <div id="screen-muat-crosscheck" class="screen">
            <button class="btn-back" onclick="switchScreen('muat-choice')">‚Üê KEMBALI</button>
            <div class="form-section">
                <div class="form-section-header">‚úÖ ADMIN CROSSCHECK <span class="section-badge">MANUAL RISIP</span>
                </div>

                <div id="crosscheck-loading"
                    style="text-align:center; padding:20px; display:none; color:var(--accent);">
                    <span class="loading-spinner-inline"></span> MEMUAT DATA...
                </div>

                <div id="crosscheck-empty" style="text-align:center; padding:30px; color:var(--muted); display:none;">
                    <div style="font-size:2rem; margin-bottom:10px;">üëç</div>
                    TIDAK ADA DATA MANUAL RISIP <br>YANG PERLU DIVALIDASI.
                </div>

                <div id="crosscheck-list"
                    style="display:flex; flex-direction:column; gap:10px; max-height:400px; overflow-y:auto;">
                    <!-- Items will be injected here -->
                </div>

                <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:20px;">
                    <div class="field-group">
                        <label>NAMA ADMIN VALIDATOR</label>
                        <input type="text" id="crosscheck_validator" placeholder="Isi Nama Admin..."
                            style="text-align:center; border:1px solid var(--accent); font-weight:bold;">
                    </div>
                    <button class="btn-submit" onclick="submitCrosscheck(this)">SIMPAN VALIDASI ‚úÖ</button>
                </div>
            </div>
        </div>

        <!-- SCREEN: MUAT SUCCESS -->
        <div class="success-overlay" id="muat-success-overlay">
            <div style="font-size:4rem; margin-bottom:20px;">‚úÖ</div>
            <h2 style="font-family:'Orbitron'; color:var(--accent); margin-bottom:10px;">DATA MUATAN TERSINKRON!</h2>
            <p style="color:var(--muted); margin-bottom:30px;">Data berhasil dikirim ke cloud.</p>
            <button class="btn-submit"
                onclick="document.getElementById('muat-success-overlay').style.display='none'; switchScreen('role');">KEMBALI
                KE HOME</button>
        </div>

        <!-- SCREEN 4: KRANI FORM -->
        <div id="screen-form" class="screen">

            <button class="btn-back" onclick="switchScreen('mode')">‚Üê GANTI MODE</button>
            <!-- SECTION 1: DATA DEFAULT (DARI SETUP) -->
            <div class="form-section">
                <div class="form-section-header">üìã DATA DEFAULT <span class="section-badge">DARI SETUP</span></div>
                <div class="input-grid">
                    <div class="field-group"><label>Tanggal</label><input type="date" id="common_tanggal"></div>
                    <div class="field-group"><label>Shift</label>
                        <select id="display_shift">
                            <option value="1">SHIFT 1</option>
                            <option value="2">SHIFT 2</option>
                            <option value="3">SHIFT 3</option>
                        </select>
                    </div>
                </div>
                <div class="field-group"><label>SLOC</label>
                    <select id="common_gudang">
                        <option value="RW01">RW01</option>
                        <option value="RW03">RW03</option>
                        <option value="RM01">RM01</option>
                    </select>
                </div>
                <div class="field-group"><label>Koordinator</label>
                    <input type="text" id="display_coordinator" placeholder="Nama Koordinator">
                </div>
                <div class="field-group"><label>Sampling Man</label>
                    <input type="text" id="display_sampling" placeholder="Nama Sampling Man">
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>Tim Borong</label>
                        <select id="display_tim_borong">
                            <option value="BADRUN">BADRUN</option>
                            <option value="KARTONO">KARTONO</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Tim Harian</label>
                        <select id="display_tim_harian">
                            <option value="WAWAN">WAWAN</option>
                            <option value="SURYANA">SURYANA</option>
                            <option value="SAHLAN">SAHLAN</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: DURASI BONGKARAN (ISI MANUAL) -->
            <div class="form-section">
                <div class="form-section-header">‚è±Ô∏è DURASI BONGKARAN <span class="section-badge">ISI MANUAL</span></div>
                <div class="field-group"><label>Nama Gudang</label>
                    <select id="common_gudang_durasi">
                        <option value="" disabled selected>-- PILIH GUDANG --</option>
                    </select>
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>1. START PANGGIL</label><input type="text" id="common_start"
                            class="time-picker"></div>
                    <div class="field-group"><label>2. TRUCK READY</label><input type="text" id="common_ready"
                            class="time-picker"></div>
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>3. START BONGKAR</label><input type="text" id="common_start_bongkar"
                            class="time-picker"></div>
                    <div class="field-group"><label>4. HOLD QC</label><input type="text" id="common_hold"
                            class="time-picker"></div>
                </div>
                <div class="input-grid">
                    <div class="field-group"><label>5. RE-START QC</label><input type="text" id="common_restart"
                            class="time-picker"></div>
                    <div class="field-group"><label>6. MANUVER AKHIR</label><input type="text" id="common_manuver"
                            class="time-picker"></div>
                </div>
                <div class="field-group"><label>7. FINISH / SELESAI</label><input type="text" id="common_finish"
                        class="time-picker"></div>
            </div>

            <!-- SECTION 3: DATA PER TRUCK (WAJIB DIISI) -->
            <div class="form-section">
                <div class="form-section-header">üöö DATA PER TRUCK <span class="section-badge">WAJIB DIISI</span></div>
                <div id="units-container"></div>
                <button class="btn-add-unit" id="btn-add-unit" onclick="addUnitRow()">‚ûï TAMBAH TRUCK LAIN</button>
            </div>

            <button class="btn-submit" onclick="submitPrecisionData(this)">SINKRON HASIL KERJA üöÄ</button>
        </div>










    </div>

    <script>
        // v18.20 AUTO INSTALL LOGIC
        let deferredPrompt;
        const installBtn = document.getElementById('btn-install-app');
        const installInstr = document.getElementById('install-instruction');

        // v18.22 SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('SW Registered!', reg))
                    .catch(err => console.log('SW Failed', err));
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            console.log("Auto-Install Ready (SW Active)");
        });

        // Fallback for when prompt is not supported (e.g. iOS or already installed)
        window.addEventListener('appinstalled', () => {
            installBtn.style.display = 'none';
            deferredPrompt = null;
            Swal.fire('Success', 'Aplikasi Terinstall! GGMU!', 'success');
        });

        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    deferredPrompt = null;
                }
            } else {
                // v18.22 Protocol Check
                if (window.location.protocol === 'file:') {
                    Swal.fire({
                        title: 'OFFLINE FILE DETECTED',
                        text: 'Fitur Auto-Install TIDAK BERFUNGSI jika membuka file HTML langsung (file://). Mohon gunakan Web Server (Live Server) atau Upload ke Hosting agar fitur PWA aktif.',
                        icon: 'warning'
                    });
                    return;
                }

                // v18.21 Manual Fallback
                Swal.fire({
                    title: 'INSTALL MANUAL',
                    html: `
                        <div style="text-align:left; font-size:0.9rem;">
                            <p>Browser ini tidak mendukung Auto-Install.</p>
                            <hr style="border:1px solid #444;">
                            <p><b>CARA INSTALL (ANDROID):</b></p>
                            <ol style="padding-left:20px;">
                                <li>Klik Ikon <b>Titik Tiga (‚ãÆ)</b> di pojok kanan atas browser.</li>
                                <li>Pilih menu <b>"Tambahkan ke Layar Utama"</b> (Add to Home Screen).</li>
                                <li>Klik <b>Add</b> / Tambahkan.</li>
                            </ol>
                            <p><b>CARA INSTALL (iOS/IPHONE):</b></p>
                            <ol style="padding-left:20px;">
                                <li>Klik Ikon <b>Share (Kotak Panah)</b>.</li>
                                <li>Pilih <b>"Add to Home Screen"</b>.</li>
                            </ol>
                        </div>
                    `,
                    icon: 'info',
                    confirmButtonText: 'SIAP LAKSANAKAN!'
                });
            }
        }

        const CONFIG = {
            API_URL: "https://script.google.com/macros/s/AKfycbwVY5kz-6qDy5cJJR-i7Ih_uwjwd_lUPf3uqNrsbeAYg1uHE6v3zrlbvhAGllh8NPeM/exec",
            SOURCE_DATA_URL: "https://script.google.com/macros/s/AKfycbwVY5kz-6qDy5cJJR-i7Ih_uwjwd_lUPf3uqNrsbeAYg1uHE6v3zrlbvhAGllh8NPeM/exec",
            GLOBAL_STOCK_URL: "https://script.google.com/macros/s/AKfycbwnStVw3UhKxgQDuTfufSlNMaTrf4ZpXC0FPAp6AK96t-YIJQNcJ1h0rtkbM2XlxPCr/exec"
        };

        let materialData = [], activeSessions = [], currentRole = '', currentInputMode = 'batch';

        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('screen-' + screenId).classList.add('active');
            if (screenId === 'tasks') loadTaskQueue();
            if (screenId === 'form') {
                const s = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
                document.getElementById('display_shift').value = s.shift || '1';
            }
            window.scrollTo(0, 0);
        }

        // v18.17 Fix: Missing Function for Resume Button
        function switchTaskChoice() {
            switchScreen('task-choice');
        }

        function handleLogoClick() {
            switchScreen('role');
        }

        function selectAction(role) {
            currentRole = role;
            if (role === 'krani') {
                openSessionPicker('input'); // Fixed: Explicit mode
            } else if (role === 'coordinator') {
                // For direct coordinator access, maybe just show setup or master data?
                // But Bos said "Koordinator Master Data & Monitoring"
                switchScreen('setup');
            } else {
                switchScreen('setup');
            }
        }

        function updateChoiceUI() {
            const inputCard = document.getElementById('choice-input-card');
            const taskTitle = document.getElementById('task-choice-title');
            const taskDesc = document.getElementById('task-choice-desc');

            // Force hide/show with !important logic
            if (currentRole === 'coordinator') {
                inputCard.setAttribute('style', 'display: none !important');
                taskTitle.innerText = "LENGKAPI CONTAINER SAYA"; // v15.0 Personal Label
                taskDesc.innerText = "Isi Arrival & Monitoring data.";
            } else {
                inputCard.setAttribute('style', 'display: flex !important');
                taskTitle.innerText = "LENGKAPI DATA SAYA";
                taskDesc.innerText = "Isi Tonase Netto yang kosong.";
            }
        }

        async function handleChoice(choice) {
            if (choice === 'input') {
                switchScreen('mode');
            } else if (choice === 'tasks') {
                switchScreen('tasks');
            }
        }

        let currentPickerMode = 'input';
        async function openSessionPicker(mode = 'input') {
            currentPickerMode = mode;
            // v17.8: Switch screen instantly
            switchScreen('session-picker');
            document.getElementById('session-list').innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted);"><span class="loading-spinner-inline"></span> MENCARI SESI AKTIF...</div>';

            await loadMasterData();
            renderSessionPicker();
        }

        async function loadMasterData() {
            const cSel = document.getElementById('setup_coordinator');

            // v16.2 Backups
            const cBackups = ["ADE YANTO", "SAFII", "HADI"];

            if (!cSel.options.length) cSel.innerHTML = cBackups.map(c => `<option value="${c}">${c}</option>`).join('');

            // v18.35: STATIC HTML FALLBACK (JS does nothing to defaults)
            // We barely trust JS now for the defaults.

            try {
                // v17.3 Dual API Fetch
                const [rDowntime, rStock] = await Promise.all([
                    fetch(CONFIG.SOURCE_DATA_URL + "?action=getData"),
                    fetch(CONFIG.GLOBAL_STOCK_URL + "?action=getData")
                ]);

                const res = await rDowntime.json();
                const stockRes = await rStock.json();

                // v19.0: Populate materialData from RM stock
                if (stockRes && stockRes.success && stockRes.materials) {
                    materialData = stockRes.materials;
                }

                // v19.1: Populate gudang dropdown from RM stock warehouses
                if (stockRes && stockRes.success && stockRes.warehouses) {
                    const gdSel = document.getElementById('common_gudang_durasi');
                    if (gdSel && gdSel.options.length <= 1) {
                        stockRes.warehouses.forEach(w => {
                            gdSel.appendChild(new Option(w, w));
                        });
                    }
                }

                // v19.1: Populate muat material dropdown
                const muatMatSel = document.getElementById('muat_material');
                if (muatMatSel && muatMatSel.options.length === 0 && materialData.length > 0) {
                    materialData.forEach(m => muatMatSel.appendChild(new Option(m.name, m.name)));
                    if (!muatMatSel.tomselect) {
                        new TomSelect('#muat_material', { create: false });
                    }
                }

                if (res.success) {
                    activeSessions = res.activeSessions || [];
                    document.getElementById('data-status-label').innerText = 'STORED (v17.3)';
                    document.getElementById('data-status-label').style.color = 'var(--success)';

                    if (res.coordinators && res.coordinators.length > 0) {
                        cSel.innerHTML = res.coordinators.map(n => `<option value="${n}">${n}</option>`).join('');
                    }
                    // v18.12 Store mined data globally
                    window.pendingKranis = res.pendingKranis || [];
                    window.pendingCoords = res.pendingCoords || [];
                }

                renderSessionPicker();
            } catch (e) {
                console.warn("Cloud slow, using local backups.", e);
            }
            loadSession();
        }

        function renderSessionPicker() {
            const container = document.getElementById('session-list');
            const isResume = (currentPickerMode === 'task-krani' || currentPickerMode === 'task-coord');
            const mainHeader = document.querySelector('#screen-session-picker .section-header');
            const title = document.querySelector('#screen-session-picker h3') || { innerText: '' };

            if (mainHeader) {
                mainHeader.innerText = isResume ? "REMINDER PENTING!" : "LANJUTKAN SESI?";
                mainHeader.style.color = isResume ? "var(--warning)" : "white";
            }

            if (currentPickerMode === 'input') title.innerText = "SIAPA NAMA ANDA?";
            else if (currentPickerMode === 'task-krani') title.innerText = "KLIK NAMAMU (LENGKAPI NETTO)";
            else title.innerText = "MODUL KORDINATOR (RESUME)";

            // v18.12 Data Mining Source
            let listData = [];
            if (currentPickerMode === 'task-krani') {
                listData = window.pendingKranis || [];
            } else if (currentPickerMode === 'task-coord') {
                listData = window.pendingCoords || [];
            } else {
                listData = activeSessions; // Mode input normal
            }

            if (!listData || listData.length === 0) {
                const emptyMsg = isResume ? "üéâ TIDAK ADA DATA PENDING. LANJUTKAN KERJA BAGUS!" : 'Belum ada sesi aktif hari ini.<br><span style="font-size:0.6rem;">Klik "SETUP AWAL SHIFT" dulu!</span>';
                container.innerHTML = `<div style="text-align:center; padding:20px; color:var(--muted);">${emptyMsg}</div>`;
                return;
            }

            // v18.0 Strict Filtering (Only for regular sessions, mining is already filtered)
            // if (currentPickerMode === 'task-krani') filtered = activeSessions.filter(s => s.hasPendingKrani);

            container.innerHTML = listData.map(item => {
                let displayName = '';
                let displayId = '';
                let subText = '';

                // Handle Mixed Data Types (String name vs Session Object)
                if (typeof item === 'string') {
                    displayName = item;
                    displayId = item;
                    subText = "KLIK UNTUK LIHAT SEMUA TUGAS PENDING";
                } else {
                    displayName = (currentPickerMode === 'task-coord') ? item.coordinator : item.krani;
                    displayId = displayName;
                    let tag = (currentPickerMode === 'input' && item.hasPendingKrani) ? '<span style="color:var(--warning); margin-left:10px;">[PENDING]</span>' : '<span style="color:var(--success); margin-left:10px;">[READY]</span>';
                    subText = `Gudang: ${item.gudang} | Shift: ${item.shift} ${tag}`;
                }

                // v18.11 Human-Centered UI (Clean Name Only for Resume)
                if (isResume) {
                    return `
                    <div style="display:flex; align-items:center; background:rgba(255,255,255,0.1); padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid var(--accent);">
                        <div style="flex:1; cursor:pointer; text-align:center;" onclick="continueAs('${String(displayId || '').replace(/'/g, "\\'")}')">
                            <div style="font-size:1.2rem; color:white; font-family:'Orbitron'; letter-spacing:2px; font-weight:bold;">${String(displayName || '').toUpperCase()}</div>
                            <div style="font-size:0.55rem; color:var(--warning); margin-top:5px;">${subText}</div>
                        </div>
                    </div>
                `;
                } else {
                    return `
                    <div style="display:flex; align-items:center; background:rgba(255,255,255,0.05); padding:12px; border-radius:12px; margin-bottom:10px; border:1px solid var(--border);">
                        <div style="flex:1; cursor:pointer;" onclick="continueAs('${String(displayId || '').replace(/'/g, "\\'")}')">
                            <div style="font-size:0.7rem; color:var(--accent); font-family:'Orbitron';">${String(displayName || '').toUpperCase()}</div>
                            <div style="font-size:0.5rem; color:var(--muted);">${subText}</div>
                        </div>
                        <button onclick="forgetSession('${String(item.krani || '').replace(/'/g, "\\'")}')" style="background:rgba(255,0,0,0.2); border:none; color:white; width:30px; height:30px; border-radius:50%; font-size:0.6rem;">X</button>
                    </div>
                `;
                }
            }).join('');
        }

        function continueAs(name) {
            const searchName = String(name || '').trim();
            // Try to find existing session first
            let session = activeSessions.find(s =>
                String(s.krani || '').trim() === searchName ||
                String(s.coordinator || '').trim() === searchName
            );

            // v18.12: If mining data, create ad-hoc session object
            if (!session) {
                // If this is a mined name, we allow it.
                // We default to '?' for shift/gudang because we just want to load tasks.
                session = {
                    krani: (currentPickerMode === 'task-krani' || currentPickerMode === 'input') ? searchName : '',
                    coordinator: (currentPickerMode === 'task-coord') ? searchName : '',
                    shift: '?',
                    gudang: '?',
                    tim_borong: '?',
                    tim_harian: '?'
                };
            }

            if (session) {
                localStorage.setItem('WHSMART_SESSION', JSON.stringify(session));
                currentRole = (currentPickerMode === 'task-coord') ? 'coordinator' : 'krani';

                // If it's ad-hoc, skip loadSession full fill, just partial
                if (session.shift !== '?') loadSession();

                if (currentPickerMode === 'input') {
                    // v19.0: Skip choice screen, go directly to mode selection
                    switchScreen('mode');
                } else {
                    switchScreen('tasks');
                }
            } else {
                console.warn("Session error for:", name);
            }
        }

        async function openUpdateForm(t) {
            // v18.14 Coordinator Container Flow
            if (currentRole === 'coordinator') {
                if (t.jenis_truck && t.jenis_truck.toUpperCase().includes('CONTAINER')) {
                    const { value: formValues } = await Swal.fire({
                        title: 'DATA CONTAINER PENDING',
                        html: `
                            <div style="text-align:left; font-size:0.9rem;">
                                <label>ARRIVAL DATE</label>
                                <input id="swal-arr-date" class="swal2-input" placeholder="Pilih Tanggal" value="${t.arrival_date || ''}">
                                <label>ARRIVAL TIME</label>
                                <input id="swal-arr-time" class="swal2-input" placeholder="Jam Arrival" value="${t.arrival_time || ''}">
                                <label>SCALING 1 TIME</label>
                                <input id="swal-qc-time" class="swal2-input" placeholder="Jam Scaling 1" value="${t.qc_time || ''}">
                                <label>SCALING TIMBANG MASUK</label>
                                <input id="swal-timbang-time" class="swal2-input" placeholder="Jam Timbang Masuk" value="${t.timbang_time || ''}">
                            </div>
                        `,
                        focusConfirm: false,
                        showCancelButton: true,
                        confirmButtonText: 'SIMPAN DATA',
                        didOpen: () => {
                            flatpickr("#swal-arr-date", { dateFormat: "Y-m-d" });
                            flatpickr("#swal-arr-time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });
                            flatpickr("#swal-qc-time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });
                            flatpickr("#swal-timbang-time", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });
                        },
                        preConfirm: () => {
                            return {
                                arrival_date: document.getElementById('swal-arr-date').value,
                                arrival_time: document.getElementById('swal-arr-time').value,
                                qc_time: document.getElementById('swal-qc-time').value,
                                timbang_time: document.getElementById('swal-timbang-time').value
                            }
                        }
                    });

                    if (formValues) {
                        // Validate emptiness
                        if (!formValues.arrival_date || !formValues.arrival_time || !formValues.qc_time || !formValues.timbang_time) {
                            Swal.fire('Error', 'Semua 4 data wajib diisi!', 'warning');
                            return;
                        }

                        // Submit
                        Swal.fire({ title: 'Updating...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        try {
                            const payload = {
                                action: 'updateCoordinator',
                                row_id: t.row_id,
                                ...formValues
                            };
                            await fetch(CONFIG.API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                            Swal.fire('Success', 'Data Container Tersimpan!', 'success').then(() => loadTaskQueue());
                        } catch (e) {
                            Swal.fire('Error', 'Gagal update database.', 'error');
                        }
                    }
                } else {
                    Swal.fire('Info', 'Fitur update untuk Non-Container belum tersedia.', 'info');
                }
                return;
            }

            // Normal Krani Logic
            const { value: netto } = await Swal.fire({
                title: 'INPUT NETTO (KG)',
                input: 'number',
                inputValue: t.netto || '',
                showCancelButton: true,
                inputValidator: (value) => {
                    if (!value) return 'Netto harus diisi!'
                }
            });

            if (netto) {
                submitTaskUpdate(t.row_id, netto);
            }
        }

        async function submitTaskUpdate(rowId, netto) {
            Swal.fire({ title: 'Saving...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                await fetch(CONFIG.API_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: 'updateNetto', row_id: rowId, netto: netto })
                });
                Swal.fire('Success', 'Netto updated!', 'success').then(() => loadTaskQueue());
            } catch (e) {
                Swal.fire('Error', 'Gagal update.', 'error');
            }
        }

        async function forgetSession(name) {
            if (confirm(`Hapus sesi setup ${name}? (Jika sudah selesai shift)`)) {
                try {
                    await fetch(CONFIG.API_URL, {
                        method: 'POST', mode: 'no-cors',
                        body: JSON.stringify({ action: 'terminateSession', krani: name })
                    });
                    activeSessions = activeSessions.filter(s => s.krani !== name);
                    renderSessionPicker();
                    const current = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
                    if (current.krani === name) localStorage.removeItem('WHSMART_SESSION');
                } catch (e) { Swal.fire('Error', 'Gagal hapus dari Cloud.', 'error'); }
            }
        }

        function loadSession() {
            const s = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
            if (s.krani) {
                // Setup form fields
                document.getElementById('setup_krani').value = s.krani;
                document.getElementById('setup_coordinator').value = s.coordinator || '';
                document.getElementById('setup_sampling').value = s.sampling || '';
                document.getElementById('setup_shift').value = s.shift || '1';
                if (document.getElementById('setup_sloc') && s.sloc) document.getElementById('setup_sloc').value = s.sloc;

                // v19.0 Auto-Fill form defaults from setup
                const ds = document.getElementById('display_shift');
                if (ds) ds.value = s.shift || '1';
                const cg = document.getElementById('common_gudang');
                if (cg && s.sloc) cg.value = s.sloc;
                const dc = document.getElementById('display_coordinator');
                if (dc && s.coordinator) dc.value = s.coordinator.toUpperCase();
                const dsm = document.getElementById('display_sampling');
                if (dsm && s.sampling) dsm.value = s.sampling.toUpperCase();
                const dtb = document.getElementById('display_tim_borong');
                if (dtb && s.tim_borong) dtb.value = s.tim_borong;
                const dth = document.getElementById('display_tim_harian');
                if (dth && s.tim_harian) dth.value = s.tim_harian;

                // Update dynamic team labels in any existing unit rows
                updateTeamLabels();
            }
        }

        function updateTeamLabels() {
            const s = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
            const borongLabel = `BORONG (${s.tim_borong || '?'})`;
            const harianLabel = `HARIAN (${s.tim_harian || '?'})`;

            document.querySelectorAll('.u-labor-type').forEach(sel => {
                sel.options[0].text = borongLabel;
                sel.options[1].text = harianLabel;
            });
        }

        async function saveSession() {
            const s = {
                shift: document.getElementById('setup_shift').value,
                sloc: document.getElementById('setup_sloc').value,
                krani: document.getElementById('setup_krani').value,
                coordinator: document.getElementById('setup_coordinator').value,
                sampling: document.getElementById('setup_sampling').value,
                tim_borong: document.getElementById('setup_tim_borong').value,
                tim_harian: document.getElementById('setup_tim_harian').value
            };

            if (!s.sloc || (!s.krani && !s.coordinator)) {
                Swal.fire('Inkomplet', 'SLOC dan setidaknya satu Nama (Krani/Koordinator) wajib diisi.', 'warning');
                return;
            }

            const btn = document.querySelector('#screen-setup .btn-submit');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner-inline"></span> SAVING IDENTITY...';
            btn.style.opacity = '0.7';

            localStorage.setItem('WHSMART_SESSION', JSON.stringify(s));

            try {
                await fetch(CONFIG.API_URL, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: 'saveSession', ...s })
                });

                // v17.9: Optimistically update activeSessions locally for instant feedback
                const idx = activeSessions.findIndex(as => as.krani === s.krani);
                const sessionData = { ...s, hasPending: false };
                if (idx !== -1) activeSessions[idx] = sessionData;
                else activeSessions.push(sessionData);

                Swal.fire('Identity Locked', 'Setup berhasil disimpan. GGMU!', 'success').then(() => { currentRole = 'krani'; loadSession(); switchScreen('mode'); });
            } catch (e) {
                Swal.fire('Identity Locked', 'Setup tersimpan lokal (Cloud slow).', 'success').then(() => { currentRole = 'krani'; loadSession(); switchScreen('mode'); });
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'SIMPAN SETUP üõ°Ô∏è';
                btn.style.opacity = '1';
            }
        }

        // ================= v13.0 TASK QUEUE LOGIC =================

        async function loadTaskQueue() {
            const container = document.getElementById('task-list-container');
            const session = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
            const name = (currentRole === 'krani') ? session.krani : session.coordinator;

            // v18.0: Header UI & Rule Awareness
            const actionTitle = (currentRole === 'krani') ? "REDAKSI: " : "ANTRIAN MONITORING: ";
            document.getElementById('task-title').innerText = actionTitle + (name || "?").toUpperCase();
            document.getElementById('krani-actions').style.display = (currentRole === 'krani') ? 'block' : 'none';
            container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--muted);">MENCARI TUGAS...</div>';

            try {
                // v18.11: Remove gudang & shift filter to show ALL pending tasks for this user
                const url = `${CONFIG.API_URL}?action=getTaskQueue&role=${currentRole}&name=${encodeURIComponent(name)}`;
                const r = await fetch(url);
                const data = await r.json();

                // Rule 7 & 8 Strict Logic
                const pending = data.filter(t => {
                    if (currentRole === 'krani') {
                        // Rule 7: Only show if Netto is missing
                        return !t.netto || t.netto === '-' || t.netto === '0';
                    } else {
                        // Rule 8: Coordinator - miss Arrival or QC or Timbang
                        // Backend helps, but secondary check here
                        return true;
                    }
                });

                if (pending.length === 0) {
                    container.innerHTML = `<div style="text-align:center; padding:30px; font-size:0.75rem; color:var(--success); font-weight:bold;">üéâ SEMUA DATA LENGKAP (GGMU!)</div>`;
                } else {
                    container.innerHTML = pending.map(t => {
                        const tglLabel = t.tanggal ? new Date(t.tanggal).toLocaleDateString('id-ID', { day: '2-digit', month: 'short' }) : '-';
                        const truckLabel = (t.jenis_truck || 'TRUCK').toUpperCase();

                        return `
                        <div class="task-card ${currentRole === 'coordinator' ? 'coord' : ''}" onclick="openUpdateForm(${JSON.stringify(t).replace(/"/g, '&quot;')})">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                                <div class="nopol">${t.nopol || 'NO NOPOL'}</div>
                                <div style="font-size:0.5rem; background:rgba(255,255,255,0.1); padding:2px 6px; border-radius:4px; color:var(--accent);">${truckLabel}</div>
                            </div>
                            <div class="mat">${t.material || 'NO MATERIAL'}</div>
                            <div class="status" style="color:var(--warning); font-size:0.55rem; margin-top:5px;">‚ö†Ô∏è ${t.status}</div>
                            <div style="font-size:0.45rem; color:var(--muted); margin-top:8px; border-top:1px solid rgba(255,255,255,0.05); padding-top:5px;">
                                GUDANG: ${t.gudang} | ${tglLabel}
                            </div>
                        </div>
                    `}).join('');
                }
            } catch (e) {
                container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--danger);">GAGAL KONEK KE CLOUD</div>';
            }
        }

        function openUpdateForm(t) {
            document.getElementById('edit-row-id').value = t.row_id;
            document.getElementById('edit-nopol').innerText = t.nopol;
            document.getElementById('edit-mat').innerText = t.material;
            document.getElementById('edit-gudang').innerText = "UNIT GUDANG: " + t.gudang;

            // v14.3: Strict Field Enforcement
            const isCoord = (currentRole === 'coordinator');
            document.getElementById('krani-edit-fields').style.display = isCoord ? 'none' : 'block';
            document.getElementById('coord-edit-fields').style.display = isCoord ? 'block' : 'none';

            document.getElementById('edit-header').innerText = isCoord ? 'LENGKAPI ARRIVAL & QC' : 'LENGKAPI TONASE NETTO';

            document.getElementById('edit-screen').style.display = 'flex';
        }

        function closeEdit() { document.getElementById('edit-screen').style.display = 'none'; }

        async function submitTaskUpdate() {
            const btn = document.getElementById('btn-update-task');
            let payload = { action: (currentRole === 'krani') ? 'updateNetto' : 'updateCoordinator', row_id: document.getElementById('edit-row-id').value };

            if (currentRole === 'krani') {
                payload.netto = document.getElementById('edit_netto').value;
                if (!payload.netto) { Swal.fire('Error', 'Netto harus diisi.', 'warning'); return; }
            } else {
                payload.arrival_date = document.getElementById('coord_arrival_date').value;
                payload.arrival_time = document.getElementById('coord_arrival_time').value;
                payload.qc_time = document.getElementById('coord_qc_time').value;
                payload.timbang_time = document.getElementById('coord_timbang_time').value;
                if (!payload.arrival_date || !payload.arrival_time) { Swal.fire('Inkomplet', 'Arrival wajib.', 'warning'); return; }
            }

            btn.disabled = true; btn.innerText = "SINKRONISASI CLOUD...";
            try {
                await fetch(CONFIG.API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('success-overlay').style.display = 'flex';
            } catch (e) {
                btn.disabled = false; btn.innerText = "COBA LAGI";
                Swal.fire('Error', 'Gagal update.', 'error');
            }
        }

        // ================= KRANI INPUT FLOW =================

        function selectInputMode(mode) {
            currentInputMode = mode;
            document.getElementById('btn-add-unit').style.display = (mode === 'batch') ? 'block' : 'none';
            document.getElementById('units-container').innerHTML = ''; addUnitRow();
            switchScreen('form');
        }

        function addUnitRow() {
            const id = 'unit-' + Date.now();
            const truckNum = document.querySelectorAll('.truck-card').length + 1;
            const sess = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
            const html = `
                <div class="truck-card unit-card" id="${id}">
                    <div class="truck-card-header">üöö TRUCK ${truckNum}</div>
                    <div class="field-group"><label>Jenis Truck</label>
                        <select class="u-jenis">
                            <option value="Container 20ft">CONTAINER 20FT</option>
                            <option value="Container 40ft">CONTAINER 40FT</option>
                            <option value="Fuso">FUSO</option>
                            <option value="Tronton">TRONTON</option>
                            <option value="Colt Diesel">COLT DIESEL</option>
                            <option value="Gandengan">GANDENGAN</option>
                            <option value="Wing Box">WING BOX</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Material RM</label><select class="u-mat" id="m-${id}"></select></div>
                    <div class="field-group"><label>Jumlah Bag</label><input type="number" class="u-jumlah-bag" placeholder="Jml Bag (Opsional)"></div>
                    <div class="input-grid">
                        <div class="field-group"><label>Nopol Truck</label><input type="text" class="u-nopol" placeholder="Contoh: B 1234 XY"></div>
                        <div class="field-group"><label>Netto (Kg)</label><input type="number" class="u-netto" placeholder="Opsional"></div>
                    </div>
                    <div class="field-group"><label>Lokasi Simpan</label><input type="text" class="u-lokasi-simpan" placeholder="Blok / Cell"></div>
                    <div class="field-group"><label>Kuli Penggarap</label>
                        <select class="u-labor-type">
                            <option value="BORONG">BORONG (${sess.tim_borong || '?'})</option>
                            <option value="HARIAN">HARIAN (${sess.tim_harian || '?'})</option>
                        </select>
                    </div>
                    <div class="field-group"><label>Jumlah Kuli</label><input type="number" class="u-jumlah-kuli" value="1" min="1" placeholder="Jumlah kuli"></div>
                </div>
            `;
            document.getElementById('units-container').insertAdjacentHTML('beforeend', html);
            const mSel = document.getElementById(`m-${id}`);
            materialData.forEach(m => mSel.appendChild(new Option(m.name, m.name)));
            new TomSelect(`#m-${id}`, { create: false });
        }

        async function submitPrecisionData(btn) {
            const session = JSON.parse(localStorage.getItem('WHSMART_SESSION'));
            if (!session) { Swal.fire('Error', 'Sesi tidak ditemukan. Harap Setup ulang.', 'error'); return; }

            // v19.0: Read form defaults (editable) instead of session-only
            const formShift = document.getElementById('display_shift').value;
            const formSloc = document.getElementById('common_gudang').value;
            const formCoord = document.getElementById('display_coordinator').value;
            const formSampling = document.getElementById('display_sampling').value;
            const formTimBorong = document.getElementById('display_tim_borong').value;
            const formTimHarian = document.getElementById('display_tim_harian').value;

            // v19.0: Smart Validation per truck
            const missingFields = [];
            let truckIdx = 0;
            document.querySelectorAll('.unit-card').forEach(row => {
                truckIdx++;
                const nopol = row.querySelector('.u-nopol').value.trim();
                const material = row.querySelector('.u-mat').value.trim();
                const lokasi = row.querySelector('.u-lokasi-simpan').value.trim();
                const jumlahKuli = row.querySelector('.u-jumlah-kuli').value.trim();
                if (!nopol) missingFields.push(`TRUCK ${truckIdx}: Nopol Truck`);
                if (!material) missingFields.push(`TRUCK ${truckIdx}: Material RM`);
                if (!lokasi) missingFields.push(`TRUCK ${truckIdx}: Lokasi Simpan`);
                if (!jumlahKuli) missingFields.push(`TRUCK ${truckIdx}: Jumlah Kuli`);
            });

            if (missingFields.length > 0) {
                Swal.fire({
                    title: 'DATA BELUM LENGKAP',
                    html: '<div style="text-align:left; font-size:0.85rem;">' +
                        missingFields.map(f => `‚ö†Ô∏è <b>${f}</b>`).join('<br>') +
                        '</div><br><small style="color:#aaa;">Netto boleh dikosongkan untuk dilengkapi nanti.</small>',
                    icon: 'warning'
                });
                return;
            }

            const units = [];
            document.querySelectorAll('.unit-card').forEach(row => {
                const laborType = row.querySelector('.u-labor-type').value;
                const team = (laborType === 'BORONG') ? formTimBorong : formTimHarian;

                units.push({
                    material: row.querySelector('.u-mat').value,
                    nopol: row.querySelector('.u-nopol').value,
                    jenis_truck: row.querySelector('.u-jenis').value,
                    netto: row.querySelector('.u-netto').value || '-',
                    tim_kerja: team || '-',
                    sloc: formSloc || 'RM01',
                    tenaga_bongkar: row.querySelector('.u-jumlah-kuli').value || 1,
                    jenis_kuli: 'KULI ' + laborType,
                    lokasi_simpan: row.querySelector('.u-lokasi-simpan').value || '-',
                    jumlah_bag: row.querySelector('.u-jumlah-bag').value || '-'
                });
            });

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner-inline"></span> SINKRONISASI CLOUD...';
                btn.style.opacity = '0.7';
            }

            const payload = {
                common: {
                    tanggal: document.getElementById('common_tanggal').value || '-',
                    shift: formShift,
                    gudang: formSloc || '-',
                    gudang_durasi: document.getElementById('common_gudang_durasi').value || '-',
                    krani: session.krani,
                    coordinator: formCoord || '-',
                    sampling_man: formSampling || '-',
                    start_panggil: document.getElementById('common_start').value || '-',
                    truck_ready: document.getElementById('common_ready').value || '-',
                    start_bongkar: document.getElementById('common_start_bongkar').value || '-',
                    hold_qc: document.getElementById('common_hold').value || '-',
                    restart_qc: document.getElementById('common_restart').value || '-',
                    manuver_akhir: document.getElementById('common_manuver').value || '-',
                    finish: document.getElementById('common_finish').value || '-'
                },
                units: units
            };

            try {
                await fetch(CONFIG.API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('success-overlay').style.display = 'flex';
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = 'SINKRON HASIL KERJA üöÄ'; btn.style.opacity = '1'; }
            }
        }

        // ===== v19.1: SUBMIT MUAT DATA =====
        async function submitMuatData(btn) {
            const tanggal = document.getElementById('muat_tanggal').value;
            const shift = document.getElementById('muat_shift').value;
            const material = document.getElementById('muat_material').value;
            const timHarian = document.getElementById('muat_tim_harian').value;
            const jumlahKuli = document.getElementById('muat_jumlah_kuli').value;
            const namaKrani = document.getElementById('muat_krani').value;

            const jumlahBag = document.getElementById('muat_jumlah_bag').value;
            const netto = document.getElementById('muat_netto').value; // v19.3

            // Validation
            const missing = [];
            if (!tanggal) missing.push('Tanggal');
            if (!material) missing.push('Material');
            if (!jumlahKuli) missing.push('Jumlah Kuli');
            if (!namaKrani) missing.push('Nama Krani Muat');

            if (missing.length > 0) {
                Swal.fire({
                    title: 'DATA BELUM LENGKAP',
                    html: missing.map(f => `‚ö†Ô∏è <b>${f}</b>`).join('<br>'),
                    icon: 'warning'
                });
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner-inline"></span> SINKRONISASI CLOUD...';
                btn.style.opacity = '0.7';
            }

            const session = JSON.parse(localStorage.getItem('WHSMART_SESSION') || '{}');
            const payload = {
                action: 'saveMuat',
                tanggal: tanggal,
                shift: shift,
                kategori_risip: document.getElementById('muat_kategori').value, // v19.4
                nopol: document.getElementById('muat_nopol').value,             // v19.4
                material: material,
                tim_harian: timHarian,
                jumlah_kuli: jumlahKuli,

                netto: netto || '-', // v19.3
                jumlah_bag: jumlahBag || '-',
                krani: namaKrani,
                bongkar_stapel: document.getElementById('muat_bongkar_stapel').value || '-',
                start_muat: document.getElementById('muat_start_muat').value || '-',
                finish: document.getElementById('muat_finish').value || '-',
                otw_pabrik: document.getElementById('muat_otw_pabrik').value || '-'
            };

            try {
                await fetch(CONFIG.API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                document.getElementById('muat-success-overlay').style.display = 'flex';
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                if (btn) { btn.disabled = false; btn.innerHTML = 'SINKRON DATA MUATAN üöÄ'; btn.style.opacity = '1'; }
            }
        }

        function handleLogoClick() { switchScreen('role'); }

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr("#common_tanggal", { dateFormat: "d-M-Y", defaultDate: "today" });
            flatpickr(".date-picker", { dateFormat: "d-M-Y", defaultDate: "today" });

            // v18.6 AUTO-FLOW TURBO Logic
            const steps = ["common_start", "common_ready", "common_start_bongkar", "common_hold", "common_restart", "common_manuver", "common_finish"];
            steps.forEach((id, idx) => {
                flatpickr("#" + id, {
                    enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true,
                    onClose: function (selectedDates, dateStr, instance) {
                        if (dateStr && idx < steps.length - 1) {
                            setTimeout(() => {
                                const nextId = steps[idx + 1];
                                const nextInput = document.getElementById(nextId);
                                if (nextInput && nextInput._flatpickr) {
                                    nextInput._flatpickr.open();
                                }
                            }, 150);
                        }
                    }
                });
            });

            // Generic time picker for others
            flatpickr(".time-picker:not([id^='common_'])", { enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true });

            // v19.1: Muat form date + time pickers
            flatpickr("#muat_tanggal", { dateFormat: "d-M-Y", defaultDate: "today" });
            const muatSteps = ["muat_bongkar_stapel", "muat_start_muat", "muat_finish", "muat_otw_pabrik"];
            muatSteps.forEach((id, idx) => {
                flatpickr("#" + id, {
                    enableTime: true, noCalendar: true, dateFormat: "H:i", time_24hr: true,
                    onClose: function (selectedDates, dateStr) {
                        if (dateStr && idx < muatSteps.length - 1) {
                            setTimeout(() => {
                                const next = document.getElementById(muatSteps[idx + 1]);
                                if (next && next._flatpickr) next._flatpickr.open();
                            }, 150);
                        }
                    }
                });
            });

            loadMasterData();
        });
        // v19.5: Monitor Crosscheck (With Netto Input)
        window.fetchManualRisip = async function () {
            const list = document.getElementById('crosscheck-list');
            const loading = document.getElementById('crosscheck-loading');
            const empty = document.getElementById('crosscheck-empty');

            list.innerHTML = '';
            loading.style.display = 'block';
            empty.style.display = 'none';

            try {
                const response = await fetch(CONFIG.SOURCE_DATA_URL + '?action=getManualRisip');
                const data = await response.json();

                loading.style.display = 'none';
                if (!data || data.length === 0) {
                    empty.style.display = 'block';
                    return;
                }

                data.forEach(item => {
                    const div = document.createElement('div');
                    div.id = `row-card-${item.row_id}`;
                    div.className = 'crosscheck-item';
                    div.style.cssText = "background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:10px; border-radius:8px; display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;";
                    div.innerHTML = `
                        <div style="border-bottom:1px solid var(--border); padding-bottom:10px; margin-bottom:10px;">
                            <div style="font-size:1.2rem; font-weight:bold; color:var(--accent); font-family:'Orbitron'; letter-spacing:1px;">${item.nopol}</div>
                            <div style="font-size:0.8rem; color:var(--muted); margin-top:5px;">üìã ${item.material} | üìÖ ${item.tanggal}</div>
                        </div>

                        <div style="display:grid; grid-template-columns: 1.2fr 0.8fr; gap:15px; align-items:end;">
                            <!-- Input Column -->
                            <div>
                                <label style="display:block; font-size:0.65rem; color:var(--muted); margin-bottom:5px; font-family:'Orbitron';">‚¨áÔ∏è ISI NETTO (KG)</label>
                                <input type="number" id="netto-${item.row_id}" class="crosscheck-netto" placeholder="0" 
                                       style="width:100%; background:rgba(0,0,0,0.3); border:1px solid var(--border); color:white; padding:12px; border-radius:8px; font-family:'Orbitron'; font-size:1.1rem; text-align:center;" step="any">
                            </div>

                            <!-- Checkbox Column -->
                            <div>
                                <label style="display:block; font-size:0.65rem; color:var(--muted); margin-bottom:5px; text-align:center; font-family:'Orbitron';">‚úÖ VALIDASI?</label>
                                <div id="btn-${item.row_id}" onclick="toggleCrosscheckRow('${item.row_id}')" 
                                     style="background:rgba(255,255,255,0.05); border:1px solid var(--muted); border-radius:8px; padding:12px; text-align:center; cursor:pointer; transition:0.3s; user-select:none;">
                                    <input type="checkbox" id="cb-${item.row_id}" class="crosscheck-checkbox" data-row="${item.row_id}" style="display:none;">
                                    <span id="txt-unchecked-${item.row_id}" style="font-size:0.9rem; color:var(--muted); font-weight:bold;">BELUM ‚ùå</span>
                                    <span id="txt-checked-${item.row_id}" style="display:none; font-size:0.9rem; color:#000; font-weight:bold;">SUDAH ‚úÖ</span>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                });
            } catch (e) {
                loading.style.display = 'none';
                list.innerHTML = `<div style="color:red; text-align:center;">Gagal memuat data: ${e.message}</div>`;
            }
        };

        window.toggleCrosscheckRow = function (rowId) {
            const cb = document.getElementById(`cb-${rowId}`);
            const btn = document.getElementById(`btn-${rowId}`);
            const card = document.getElementById(`row-card-${rowId}`);
            const txtUn = document.getElementById(`txt-unchecked-${rowId}`);
            const txtCh = document.getElementById(`txt-checked-${rowId}`);

            if (!cb || !btn) return; // Safety check

            // Toggle State
            cb.checked = !cb.checked;

            if (cb.checked) {
                // Card Glow
                if (card) {
                    card.style.borderColor = 'var(--success)';
                    card.style.boxShadow = '0 0 20px rgba(0, 255, 136, 0.2)';
                    card.style.background = 'rgba(0, 255, 136, 0.05)';
                }

                // Button Active
                btn.style.background = 'var(--success)';
                btn.style.borderColor = 'var(--success)';
                btn.style.boxShadow = '0 0 15px var(--success)';

                // Text Change
                if (txtUn) txtUn.style.display = 'none';
                if (txtCh) txtCh.style.display = 'inline';
            } else {
                // Reset Visuals
                if (card) {
                    card.style.borderColor = 'var(--border)';
                    card.style.boxShadow = 'none';
                    card.style.background = 'rgba(255,255,255,0.05)';
                }

                btn.style.background = 'rgba(255,255,255,0.05)';
                btn.style.borderColor = 'var(--muted)';
                btn.style.boxShadow = 'none';

                if (txtUn) txtUn.style.display = 'inline';
                if (txtCh) txtCh.style.display = 'none';
            }
        };

        window.submitCrosscheck = async function (btn) {
            const validator = document.getElementById('crosscheck_validator').value;
            if (!validator) {
                Swal.fire('Warning', 'Harap isi Nama Admin Validator!', 'warning');
                return;
            }

            const checkboxes = document.querySelectorAll('.crosscheck-checkbox:checked');
            if (checkboxes.length === 0) {
                Swal.fire('Warning', 'Tidak ada data yang dipilih!', 'warning');
                return;
            }

            const updates = [];
            const missingNetto = [];

            checkboxes.forEach(cb => {
                const rowId = parseInt(cb.dataset.row);
                const nettoInput = document.getElementById(`netto-${rowId}`);
                const nettoVal = nettoInput ? nettoInput.value : "";

                if (!nettoVal || nettoVal <= 0) {
                    missingNetto.push(rowId);
                    nettoInput.style.border = "1px solid red";
                } else {
                    nettoInput.style.border = "1px solid var(--border)";
                    updates.push({ row_id: rowId, netto: nettoVal });
                }
            });

            if (missingNetto.length > 0) {
                Swal.fire('Warning', 'Harap isi NETTO (Kg) untuk semua item yang dicentang!', 'warning');
                return;
            }

            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading-spinner-inline"></span> MENYIMPAN...';
            }

            try {
                const payload = {
                    action: 'saveCrosscheck',
                    updates: updates,
                    validator: validator
                };
                await fetch(CONFIG.API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
                Swal.fire('Sukses', 'Data Validasi & Netto Berhasil Disimpan!', 'success').then(() => {
                    fetchManualRisip();
                    document.getElementById('crosscheck_validator').value = '';
                });
            } catch (e) {
                Swal.fire('Error', e.message, 'error');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = 'SIMPAN VALIDASI ‚úÖ';
                }
            }
        };
    </script>
    <div style="text-align:center; padding:20px; color:var(--muted); font-size:0.6rem; font-family:'Orbitron';">
        WHSMART SYSTEM v18.35 (STATIC HTML)<br>
        <span style="color:var(--accent)">GGMU!</span>
    </div>
</body>

</html>